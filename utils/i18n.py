"""
简单国际化：根据 config 中的 locale（zh / en）返回对应文案。
使用 t("key") 获取当前语言下的字符串；缺 key 时返回 key 本身。
get_locale() 带短时缓存，避免每次 t() 都读盘导致界面卡顿。
"""
import time
from typing import Optional

# locale 缓存：避免每次 t() 都 Settings().load() 造成英文界面卡顿
_LOCALE_CACHE: Optional[str] = None
_LOCALE_CACHE_TS: float = 0
_LOCALE_CACHE_TTL_SEC: float = 2.0

# key -> { "zh": "中文", "en": "English" }
_STRINGS = {
    "settings_title": {"zh": "设置", "en": "Settings"},
    "settings_saved_title": {"zh": "设置已保存", "en": "Settings saved"},
    "settings_saved_message": {"zh": "设置已经保存了噢", "en": "Settings saved."},
    "save": {"zh": "保存", "en": "Save"},
    "saving": {"zh": "保存中…", "en": "Saving…"},
    "gateway_card_desc": {"zh": "Gateway 连接与认证、自动登录等，在独立页面中配置。", "en": "Gateway connection and auth, auto-login, etc. Configure in the dedicated page."},
    "gateway_settings_btn": {"zh": "Gateway 设置", "en": "Gateway settings"},
    "chat_card": {"zh": "聊天", "en": "Chat"},
    "chat_font_desc": {"zh": "文字大小作用于聊天窗口与会话列表；弹窗大小作用于斜杠命令补全等弹窗。保存后生效。", "en": "Font size applies to chat and session list; popup size applies to slash command completion. Takes effect after save."},
    "font_size_label": {"zh": "文字大小", "en": "Font size"},
    "popup_size_label": {"zh": "弹窗大小", "en": "Popup size"},
    "popup_small": {"zh": "小", "en": "Small"},
    "popup_medium": {"zh": "中", "en": "Medium"},
    "popup_large": {"zh": "大", "en": "Large"},
    "behavior_card": {"zh": "行为与优化", "en": "Behavior & optimization"},
    "auto_interaction": {"zh": "自动互动任务", "en": "Auto interaction task"},
    "interaction_interval": {"zh": "互动间隔", "en": "Interval"},
    "cooldown_window": {"zh": "冲突检测窗口", "en": "Cooldown window"},
    "session_key_label": {"zh": "自动交互 sessionKey", "en": "Auto interaction sessionKey"},
    "pet_card": {"zh": "助手基础", "en": "Assistant"},
    "pet_name_label": {"zh": "助手名称", "en": "Assistant name"},
    "pet_size_label": {"zh": "体型", "en": "Size"},
    "bubble_card": {"zh": "气泡", "en": "Bubble"},
    "bubble_enabled": {"zh": "开启气泡", "en": "Enable bubble"},
    "logs_card_desc": {"zh": "实时查看主程序与 Gateway 日志（tail）。", "en": "View main and Gateway logs (tail) in real time."},
    "logs_tail_btn": {"zh": "日志 tail", "en": "Log tail"},
    "cache_card_desc": {"zh": "移除本地日志（assistant_*.log）或 Gateway 日志（gateway.*.log）。", "en": "Remove local logs (assistant_*.log) or Gateway logs (gateway.*.log)."},
    "clear_cache_btn": {"zh": "打开清除缓存", "en": "Clear cache"},
    "language_label": {"zh": "界面语言", "en": "Language"},
    "language_zh": {"zh": "中文", "en": "Chinese"},
    "language_en": {"zh": "English", "en": "English"},
    "general_card": {"zh": "通用", "en": "General"},
    "connection_card": {"zh": "连接", "en": "Connection"},
    "logs_card": {"zh": "日志", "en": "Logs"},
    "cache_card": {"zh": "数据与缓存", "en": "Data & cache"},
    "add_character_btn": {"zh": "添加助手", "en": "Add character"},
    "add_character_tooltip": {"zh": "新建助手并配置表情图集", "en": "Create new assistant and configure sprites"},
    "add_character_title": {"zh": "添加助手", "en": "Add assistant"},
    "add_pet_folder_label": {"zh": "助手文件夹名称", "en": "Assistant folder name"},
    "add_pet_folder_placeholder": {"zh": "英文或数字，如 p_bot、my_assistant", "en": "Letters/numbers, e.g. p_bot, my_assistant"},
    "add_pet_folder_tooltip": {"zh": "仅英文、数字、下划线，且必须以英文字母开头", "en": "Letters, digits, underscore only; must start with a letter"},
    "add_pet_name_label": {"zh": "助手名称", "en": "Assistant name"},
    "add_pet_name_placeholder": {"zh": "显示用名称，英文开头", "en": "Display name, start with letter"},
    "add_pet_bot_id_label": {"zh": "助手 ID（自动）", "en": "Assistant ID (auto)"},
    "add_pet_description_label": {"zh": "助手介绍", "en": "Description"},
    "add_pet_description_placeholder": {"zh": "可填写中文介绍", "en": "Description, Chinese allowed"},
    "add_pet_sprites_card": {"zh": "表情图集", "en": "Sprite sets"},
    "add_pet_sprites_hint": {"zh": "每个表情可选 1.png～30.png，必须从 1 开始连续；多选后复制到对应目录。", "en": "Each set: 1.png to 30.png, must start at 1 and be continuous."},
    "add_pet_select_images": {"zh": "选择图片", "en": "Select images"},
    "add_pet_selected_fmt": {"zh": "已选 %d 张", "en": "%d selected"},
    "add_pet_ok": {"zh": "确定添加", "en": "Add"},
    "add_pet_validation_folder_no_chinese": {"zh": "助手文件夹名称不能包含汉字，且必须以英文字母开头", "en": "Folder name: no Chinese, must start with a letter"},
    "add_pet_validation_name_no_chinese": {"zh": "助手名称不能包含汉字，且必须以英文字母开头", "en": "Assistant name: no Chinese, must start with a letter"},
    "add_pet_validation_folder_empty": {"zh": "请填写助手文件夹名称", "en": "Please enter folder name"},
    "add_pet_validation_name_empty": {"zh": "请填写助手名称", "en": "Please enter assistant name"},
    "add_pet_validation_folder_exists": {"zh": "该文件夹已存在，请换一个名称", "en": "Folder already exists, use another name"},
    "add_pet_validation_sprites_continuous": {"zh": "图片必须为 1.png、2.png、… 连续编号，且从 1 开始（不能从 2.png 开头）", "en": "Files must be 1.png, 2.png, ... continuous, starting from 1"},
    "add_pet_validation_sprites_max": {"zh": "每个表情最多 30 张图片", "en": "Max 30 images per set"},
    "add_pet_success": {"zh": "助手已添加，可在右键菜单「选择机器人」中切换", "en": "Assistant added. Switch via right-click menu > Select robot"},
    "add_pet_failed": {"zh": "添加失败", "en": "Add failed"},
    "edit_pet_btn": {"zh": "编辑助手", "en": "Edit assistant"},
    "edit_pet_tooltip": {"zh": "修改助手资料或删除助手", "en": "Edit or delete assistant"},
    "edit_pet_title": {"zh": "编辑助手", "en": "Edit assistant"},
    "edit_pet_select_label": {"zh": "选择要编辑的助手", "en": "Select assistant to edit"},
    "edit_pet_folder_readonly": {"zh": "助手文件夹（不可改）", "en": "Assistant folder (read-only)"},
    "edit_pet_save": {"zh": "保存修改", "en": "Save"},
    "edit_pet_delete": {"zh": "删除助手", "en": "Delete assistant"},
    "edit_pet_delete_confirm": {"zh": "确定要删除该助手吗？删除后不可恢复。", "en": "Delete this assistant? This cannot be undone."},
    "edit_pet_deleted": {"zh": "助手已删除", "en": "Assistant deleted"},
    "edit_pet_saved": {"zh": "助手资料已保存", "en": "Assistant saved"},
    "edit_pet_overwrite_confirm": {"zh": "以下表情文件夹中已有图片，保存将覆盖：%s。是否继续？", "en": "These sprite folders already have images and will be overwritten: %s. Continue?"},
    "edit_pet_no_pet": {"zh": "请先选择要编辑的助手", "en": "Please select an assistant to edit"},
    "edit_pet_no_pets": {"zh": "暂无助手，请先添加助手", "en": "No assistants. Add a character first."},
    "task_manager_open_btn": {"zh": "打开任务管理", "en": "Open task manager"},
    "task_manager_card_desc": {"zh": "查看与管理定时任务、周期任务。", "en": "View and manage timed and recurring tasks."},
    "locale_switched_zh": {"zh": "语言已切换为中文，重新打开设置后生效", "en": "Language set to Chinese. Reopen Settings to apply."},
    "locale_switched_en": {"zh": "语言已切换为 English，重新打开设置后生效", "en": "Language set to English. Reopen Settings to apply."},
    "current_suffix": {"zh": " 当前", "en": " (current)"},
    "voice_settings_menu": {"zh": "语音设置", "en": "Voice"},
    "voice_on": {"zh": "语音：开", "en": "Voice: on"},
    "voice_off": {"zh": "语音：关", "en": "Voice: off"},
    "speed_menu": {"zh": "移动速度", "en": "Speed"},
    "speed_0": {"zh": "禁止 (0)", "en": "Off (0)"},
    "speed_1": {"zh": "慢 (1)", "en": "Slow (1)"},
    "speed_2": {"zh": "中 (2)", "en": "Medium (2)"},
    "speed_3": {"zh": "快 (3)", "en": "Fast (3)"},
    "size_menu": {"zh": "助手大小", "en": "Size"},
    "size_small": {"zh": "小 (100x100)", "en": "Small (100x100)"},
    "size_medium": {"zh": "中 (150x150)", "en": "Medium (150x150)"},
    "size_large": {"zh": "大 (200x200)", "en": "Large (200x200)"},
    "state_menu": {"zh": "助手状态", "en": "State"},
    "state_idle": {"zh": "待机", "en": "Idle"},
    "state_walking": {"zh": "行走", "en": "Walking"},
    "state_dragging": {"zh": "拖拽", "en": "Dragging"},
    "state_happy": {"zh": "开心", "en": "Happy"},
    "state_sad": {"zh": "伤心", "en": "Sad"},
    "state_thinking": {"zh": "思考", "en": "Thinking"},
    "state_paused": {"zh": "暂停", "en": "Paused"},
    "cancel_force": {"zh": "取消强制", "en": "Cancel force"},
    "state_no_sprites": {"zh": "该状态无精灵图，不支持切换", "en": "No sprites for this state"},
    "select_robot_menu": {"zh": "选择机器人", "en": "Select robot"},
    "chat_menu": {"zh": "聊天", "en": "Chat"},
    "settings_menu": {"zh": "设置", "en": "Settings"},
    "config_setting_menu": {"zh": "配置文件设置", "en": "Config"},
    "task_manager_menu": {"zh": "任务管理", "en": "Tasks"},
    "quit_menu": {"zh": "退出", "en": "Quit"},
    "restart_menu": {"zh": "重启", "en": "Restart"},
    "tip_title": {"zh": "提示", "en": "Tip"},
    "pet_default_name": {"zh": "助手", "en": "Assistant"},
    "error_open_failed": {"zh": "打开失败", "en": "Open failed"},
    "gateway_settings_tooltip": {"zh": "打开 Gateway 设置页面", "en": "Open Gateway settings"},
    "auto_interaction_tooltip": {"zh": "助手会按间隔从已启用技能中随机选一个与用户互动", "en": "Assistant will randomly run a skill at intervals"},
    "interval_minutes_suffix": {"zh": " 分钟", "en": " min"},
    "interval_tooltip": {"zh": "自动互动任务执行间隔", "en": "Auto interaction interval"},
    "cooldown_tooltip": {"zh": "与其它任务或 AI 请求在此时间内则跳过自动互动（仅支持手动输入）", "en": "Skip auto interaction if other task/AI in this window"},
    "session_key_placeholder": {"zh": "如 agent:work:claw_pet", "en": "e.g. agent:work:claw_pet"},
    "session_key_tooltip": {"zh": "自动互动使用的 sessionKey，如 agent:work:claw_pet；可从会话管理窗口右键会话复制", "en": "SessionKey for auto interaction; copy from session list"},
    "pet_name_placeholder": {"zh": "如：小强", "en": "e.g. Assistant"},
    "pet_name_tooltip": {"zh": "当前助手的显示名称", "en": "Current assistant display name"},
    "pet_size_1": {"zh": "小 (1)", "en": "Small (1)"},
    "pet_size_2": {"zh": "中 (2)", "en": "Medium (2)"},
    "pet_size_3": {"zh": "大 (3)", "en": "Large (3)"},
    "pet_size_tooltip": {"zh": "助手窗口体型", "en": "Assistant window size"},
    "bubble_tooltip": {"zh": "关闭后不再显示助手说话气泡", "en": "Disable speech bubble"},
    "anim_card": {"zh": "状态与动画", "en": "State & animation"},
    "anim_interval_label": {"zh": "动画帧间隔", "en": "Frame interval"},
    "anim_interval_tooltip": {"zh": "默认动画帧间隔", "en": "Default frame interval"},
    "pause_resume_label": {"zh": "暂停恢复延迟", "en": "Pause resume delay"},
    "pause_resume_tooltip": {"zh": "暂停后多少秒恢复游走", "en": "Seconds before resuming walk"},
    "move_interval_label": {"zh": "游走步长间隔", "en": "Walk step interval"},
    "move_interval_tooltip": {"zh": "游走步长间隔", "en": "Walk step interval"},
    "state_hold_label": {"zh": "状态保持时间", "en": "State hold time"},
    "state_hold_tooltip": {"zh": "状态最少保持时间", "en": "Min state hold time"},
    "happy_hold_label": {"zh": "操作后 happy 保持", "en": "Happy after action"},
    "happy_hold_tooltip": {"zh": "操作后 happy 保持多久再切回走路", "en": "How long to stay happy before walk"},
    "seconds_suffix": {"zh": " 秒", "en": " s"},
    "ms_suffix": {"zh": " ms", "en": " ms"},
    "locale_tooltip": {"zh": "界面语言；保存后重新打开设置或重启生效", "en": "UI language; reopen Settings or restart to apply"},
    "chat_font_tooltip": {"zh": "聊天窗口与会话列表的文字大小（磅）", "en": "Font size for chat and session list (pt)"},
    "pt_suffix": {"zh": " 磅", "en": " pt"},
    "popup_size_tooltip": {"zh": "斜杠命令补全等弹窗的尺寸；默认小", "en": "Slash completion popup size; default small"},
    "chat_window_title": {"zh": "聊天 - ", "en": "Chat - "},
    "current_session_label": {"zh": "当前会话: ", "en": "Session: "},
    "switch_model_btn": {"zh": "切换模型", "en": "Switch model"},
    "input_placeholder": {"zh": "输入消息...（Enter 发送，Shift+Enter 换行；输入 / 显示斜杠命令补全）", "en": "Type message... (Enter send, / for slash commands)"},
    "abort_btn": {"zh": "中止", "en": "Abort"},
    "send_btn": {"zh": "发送", "en": "Send"},
    "menu_label": {"zh": "菜单", "en": "Menu"},
    "font_size_menu": {"zh": "文字大小", "en": "Font size"},
    "session_list_title": {"zh": "会话管理 - ", "en": "Sessions - "},
    "session_list_menu": {"zh": "会话管理", "en": "Sessions"},
    "gateway_settings_title": {"zh": "Gateway 设置", "en": "Gateway settings"},
    "gateway_saved_title": {"zh": "保存成功", "en": "Saved"},
    "gateway_saved_ok": {"zh": "Gateway 设置已保存", "en": "Gateway settings saved."},
    "gateway_save_failed": {"zh": "Gateway 设置保存失败", "en": "Gateway settings save failed"},
    "startup_title": {"zh": "连接 OpenClaw Gateway", "en": "Connect OpenClaw Gateway"},
    "config_setting_title": {"zh": "配置文件设置", "en": "Config"},
    "task_manager_title": {"zh": "任务管理", "en": "Task manager"},
    "log_tail_title": {"zh": "日志 tail", "en": "Log tail"},
    "clear_cache_title": {"zh": "清除缓存", "en": "Clear cache"},
    "save_failed": {"zh": "保存失败", "en": "Save failed"},
    "load_failed_message": {"zh": "加载配置失败，无法保存。", "en": "Failed to load config, cannot save."},
    "auto_interaction_session_warn": {"zh": "已勾选「自动互动任务」时请填写自动交互 sessionKey（如 agent:work:claw_pet）。\n可在会话管理窗口选中会话后右键「复制 sessionKey」。", "en": "When auto interaction is enabled, fill in sessionKey (e.g. agent:work:claw_pet).\nCopy from session list via right-click."},
    "auto_interaction_session_invalid": {"zh": "填写的 sessionKey 不在当前 Gateway 会话列表中，请先在会话管理窗口确认会话存在并复制其 sessionKey，或先新建会话后再保存。\n当前会话列表为空时请先连接 Gateway 并打开会话管理加载列表。", "en": "SessionKey not in Gateway session list. Confirm in session list or create a session first."},
    "switch_model_tooltip": {"zh": "对本会话发送 sessions.patch，切换该会话使用的模型", "en": "Send sessions.patch to switch model for this session"},
    "abort_tooltip": {"zh": "中止当前 AI 回复（与 Web 版一致）", "en": "Abort current AI reply"},
    "switch_model_dialog_title": {"zh": "切换模型（本会话）", "en": "Switch model (this session)"},
    "switch_model_dialog_label": {"zh": "选择要切换到的模型（对本会话 session 生效）：", "en": "Select model for this session:"},
    "switch_model_success": {"zh": "本会话已切换为模型：%s", "en": "Session switched to model: %s"},
    "switch_model_failed": {"zh": "切换模型失败", "en": "Switch model failed"},
    "no_gateway_switch": {"zh": "未连接 Gateway，无法切换模型", "en": "Not connected to Gateway, cannot switch model"},
    "no_config_switch": {"zh": "暂无配置，请先连接 Gateway 并拉取配置", "en": "No config. Connect Gateway and fetch config first."},
    "no_model_config": {"zh": "暂无模型配置", "en": "No model config"},
    "no_text_reply": {"zh": "（暂无文字回复）", "en": "(No text reply)"},
    "no_gateway_reply": {"zh": "未连接 Gateway", "en": "Not connected to Gateway"},
    "reply_error_fmt": {"zh": "（无法获取回复：%s）", "en": "(Failed to get reply: %s)"},
    "no_gateway_configure": {"zh": "（未连接 Gateway，请在设置中配置连接地址与认证）", "en": "(Not connected. Configure Gateway in Settings.)"},
    "pet_working": {"zh": "正在工作中", "en": "Working"},
    "log_tail_tooltip": {"zh": "打开实时日志窗口", "en": "Open real-time log window"},
    "clear_cache_tooltip_btn": {"zh": "移除本地日志或 Gateway 日志", "en": "Remove local or Gateway logs"},
    "session_label_fmt": {"zh": "当前会话: %s", "en": "Session: %s"},
    "unknown_error": {"zh": "未知错误", "en": "Unknown error"},
    "gateway_online": {"zh": "在线", "en": "Online"},
    "gateway_offline": {"zh": "不在线", "en": "Offline"},
    "gateway_connect_group": {"zh": "连接与认证", "en": "Connection & auth"},
    "gateway_desc": {"zh": "与 Web 版一致：填写 Gateway 地址与认证信息。保存后生效；若需立即应用连接请点击「保存并重连」。自动登录：勾选后下次启动将自动连接；不勾选则需在启动页手动连接。", "en": "Enter Gateway URL and auth. Save to apply; click Save & reconnect to connect now. Auto login: connect automatically on next start."},
    "gateway_url_placeholder": {"zh": "ws://127.0.0.1:18789 或 wss://host:port", "en": "ws://127.0.0.1:18789 or wss://host:port"},
    "gateway_url_label": {"zh": "Gateway 地址：", "en": "Gateway URL:"},
    "gateway_token_label": {"zh": "Token：", "en": "Token:"},
    "gateway_token_placeholder": {"zh": "可选，网关启用认证时必填", "en": "Optional, required when auth enabled"},
    "gateway_password_label": {"zh": "密码：", "en": "Password:"},
    "gateway_password_placeholder": {"zh": "可选，部分网关使用密码", "en": "Optional"},
    "gateway_auto_login": {"zh": "自动登录", "en": "Auto login"},
    "gateway_auto_login_tooltip": {"zh": "勾选为 true：下次启动自动连接；不勾选为 false：需在启动页手动连接", "en": "Checked: auto connect on next start"},
    "save_and_reconnect": {"zh": "保存并重连", "en": "Save & reconnect"},
    "save_and_reconnect_tooltip": {"zh": "先保存当前表单，再使用保存后的配置重连", "en": "Save then reconnect with new config"},
    "reconnect_btn": {"zh": "重连", "en": "Reconnect"},
    "reconnect_tooltip": {"zh": "使用已保存的配置立即重连（不修改当前表单）", "en": "Reconnect with saved config"},
    "gateway_connected_ok": {"zh": "gateway链接成功，现在可以开心的玩耍了", "en": "Gateway connected. Ready to go."},
    "gateway_disconnected": {"zh": "gateway链接断开了，快快检查一下把", "en": "Gateway disconnected. Please check."},
    "gateway_restart_fmt": {"zh": "Gateway 即将重启，约 %s 秒后重连", "en": "Gateway restarting, reconnecting in ~%s s"},
    "startup_host_placeholder": {"zh": "例如 127.0.0.1 或 localhost", "en": "e.g. 127.0.0.1 or localhost"},
    "startup_port_placeholder": {"zh": "默认 18789", "en": "Default 18789"},
    "startup_server_addr": {"zh": "服务器地址：", "en": "Server:"},
    "startup_port": {"zh": "端口：", "en": "Port:"},
    "startup_token": {"zh": "Token：", "en": "Token:"},
    "connect_and_start": {"zh": "连接并启动", "en": "Connect & start"},
    "cancel_btn": {"zh": "取消", "en": "Cancel"},
    "auto_login_connecting": {"zh": "自动登录中…", "en": "Auto connecting…"},
    "connecting": {"zh": "连接中…", "en": "Connecting…"},
    "auto_login_failed": {"zh": "自动登录失败", "en": "Auto login failed"},
    "connect_failed": {"zh": "连接失败", "en": "Connect failed"},
    "connect_failed_msg": {"zh": "无法连接到 Gateway，请检查地址、端口与 Token。", "en": "Cannot connect. Check address, port and Token."},
    "log_source_label": {"zh": "日志来源:", "en": "Log source:"},
    "log_main": {"zh": "主程序 (pet_YYYYMMDD.log)", "en": "Main (pet_YYYYMMDD.log)"},
    "log_gateway_local": {"zh": "本地 Gateway (gateway.YYYYMMDD.log)", "en": "Local Gateway (gateway.YYYYMMDD.log)"},
    "log_gateway_remote": {"zh": "远程 Gateway (logs.tail)", "en": "Remote Gateway (logs.tail)"},
    "pause_btn": {"zh": "暂停", "en": "Pause"},
    "clear_cache_prompt": {"zh": "请选择要清除的日志：", "en": "Select logs to clear:"},
    "remove_local_logs": {"zh": "移除本地日志", "en": "Remove local logs"},
    "remove_gateway_logs": {"zh": "移除 Gateway 日志", "en": "Remove Gateway logs"},
    "remove_remote_logs": {"zh": "移除远程日志", "en": "Remove remote logs"},
    "done_title": {"zh": "完成", "en": "Done"},
    "fail_title": {"zh": "失败", "en": "Failed"},
    "theme_card": {"zh": "主题", "en": "Theme"},
    "theme_follow_system": {"zh": "跟随系统", "en": "Follow system"},
    "theme_light": {"zh": "浅色", "en": "Light"},
    "theme_dark": {"zh": "深色", "en": "Dark"},
    "startup_default_hint": {"zh": "默认：本地 127.0.0.1，端口 18789。", "en": "Default: 127.0.0.1, port 18789."},
    "clear_local_done_fmt": {"zh": "已移除 %d 个本地日志文件（assistant_*.log）。", "en": "Removed %d local log file(s) (assistant_*.log)."},
    "clear_remote_done_fmt": {"zh": "已移除 %d 个远程日志文件（remote_gateway_*.log）。", "en": "Removed %d remote log file(s)."},
    "clear_gateway_done_fmt": {"zh": "已移除 %d 个 Gateway 日志文件（gateway.*.log）。", "en": "Removed %d Gateway log file(s)."},
    "config_status_hint": {"zh": "连接 Gateway 后点击下方按钮拉取当前配置。", "en": "Connect Gateway then click below to fetch config."},
    "config_read_btn": {"zh": "读取当前配置", "en": "Fetch config"},
    "config_edit_btn": {"zh": "编辑当前配置", "en": "Edit config"},
    "config_read_btn_tooltip_session": {"zh": "从 Gateway 拉取 openclaw 配置并只读展示（与配置设置中「读取当前配置」相同）", "en": "Fetch openclaw config from Gateway and show read-only (same as Config settings)."},
    "config_edit_btn_tooltip_session": {"zh": "编辑已拉取的配置并保存到 Gateway（需先读取配置；与配置设置中「编辑当前配置」相同）", "en": "Edit fetched config and save to Gateway (fetch first; same as Config settings)."},
    "config_not_connected": {"zh": "未连接 Gateway，无法拉取配置", "en": "Not connected to Gateway"},
    "config_fetching": {"zh": "正在拉取配置…", "en": "Fetching config…"},
    "config_fetch_failed": {"zh": "拉取失败", "en": "Fetch failed"},
    "session_list_title_prefix": {"zh": "会话管理 - ", "en": "Sessions - "},
    "task_manager_window_title": {"zh": "任务管理", "en": "Task manager"},
    "theme_desc": {"zh": "与 Web 版一致：选择界面主题。部分窗口需重启后生效。", "en": "Choose theme. Some windows need restart to apply."},
    "theme_label": {"zh": "主题：", "en": "Theme:"},
    "theme_tooltip": {"zh": "system=跟随系统，light=浅色，dark=深色", "en": "system=follow system, light=light, dark=dark"},
    # 弹窗 / 对话框
    "config_view_title": {"zh": "配置文件（只读）", "en": "Config (read-only)"},
    "model_config_title": {"zh": "模型配置", "en": "Model config"},
    "copy_config": {"zh": "复制配置", "en": "Copy config"},
    "model_provider_not_found": {"zh": "未找到该模型对应的 provider 配置（models.providers 中无此 key）", "en": "Provider config not found for this model (key not in models.providers)."},
    "config_copied": {"zh": "已复制到剪贴板", "en": "Copied to clipboard."},
    "config_view_mode_raw": {"zh": "Raw 模式", "en": "Raw"},
    "config_view_mode_form": {"zh": "表单模式", "en": "Form (tree)"},
    "config_view_tree_key": {"zh": "键", "en": "Key"},
    "config_view_tree_value": {"zh": "值", "en": "Value"},
    "config_view_parse_error": {"zh": "无法解析为 JSON", "en": "Not valid JSON"},
    "config_edit_dialog_title": {"zh": "编辑配置", "en": "Edit config"},
    "config_format_error_title": {"zh": "格式错误", "en": "Format error"},
    "config_format_error_text": {"zh": "配置不是合法的 JSON，请修正语法后重试。", "en": "Config is not valid JSON. Fix syntax and retry."},
    "config_save_failed_title": {"zh": "保存失败", "en": "Save failed"},
    "config_not_connected_save": {"zh": "未连接 Gateway，无法保存配置。", "en": "Not connected to Gateway, cannot save config."},
    "config_server_reject": {"zh": "服务端拒绝保存配置（配置校验未通过）。", "en": "Server rejected config (validation failed)."},
    "config_no_data": {"zh": "无数据", "en": "No data"},
    "config_fetched_open": {"zh": "已拉取，已打开只读窗口", "en": "Fetched, read-only window opened"},
    "config_please_fetch_first": {"zh": "请先点击「读取当前配置」", "en": "Please click Fetch config first"},
    "config_please_fetch_then_edit": {"zh": "请先点击「读取当前配置」拉取配置后再编辑。", "en": "Fetch config first, then edit."},
    "config_edit_confirm_title": {"zh": "提示", "en": "Tip"},
    "config_edit_confirm_text": {"zh": "修改配置可能导致异常，注意提前备份。", "en": "Editing config may cause issues. Backup first."},
    "config_edit_confirm_info": {"zh": "确认后进入编辑。", "en": "Confirm to enter edit."},
    "config_edit_not_supported": {"zh": "暂不支持修改配置。", "en": "Modifying config is not supported yet."},
    "add_model_save_not_supported": {"zh": "暂不支持保存。", "en": "Saving is not supported yet."},
    "config_saved": {"zh": "配置已保存", "en": "Config saved"},
    "config_edit_placeholder": {"zh": "JSON 配置，支持语法高亮；保存时将自动格式化缩进，仅语法错误会报错。", "en": "JSON config. Save will format; only syntax errors are reported."},
    "config_fetch_failed_title": {"zh": "配置拉取失败", "en": "Config fetch failed"},
    "config_no_snapshot": {"zh": "未返回有效快照", "en": "No valid snapshot"},
    "add_model_dialog_title": {"zh": "增加模型", "en": "Add model"},
    "add_model_hint": {"zh": "请参考下方模板填写模型信息；保存功能暂未开放，需在配置文件中修改。", "en": "Fill model info per template. Save not supported; edit config file."},
    "add_model_mode_form": {"zh": "表单模式", "en": "Form"},
    "add_model_mode_raw": {"zh": "Raw 模式", "en": "Raw JSON"},
    "add_model_field_model_name": {"zh": "model_name", "en": "model_name"},
    "add_model_field_name": {"zh": "name", "en": "name"},
    "add_model_group_first_model": {"zh": "第一个模型项 (models[0])", "en": "First model (models[0])"},
    "add_model_group_model_item": {"zh": "models[%d]（第 %d 个元素）", "en": "models[%d] (element %d)"},
    "add_model_add_item_btn": {"zh": "增加配置", "en": "Add config"},
    "add_model_add_item_tooltip": {"zh": "向 models[] 中再添加一个元素（一组 id/name/reasoning/input/cost 等）", "en": "Add one more element to models[] (id, name, reasoning, input, cost, etc.)"},
    "add_model_raw_parse_error": {"zh": "JSON 解析失败，请检查格式", "en": "Invalid JSON, check format"},
    "add_model_validation_fail": {"zh": "不符合规范，请重新填写。", "en": "Validation failed. Please correct and resubmit."},
    "add_model_validation_fix_raw": {"zh": "请修正 Raw 模式中的 JSON 后重试。", "en": "Fix JSON in Raw mode and try again."},
    "add_model_validation_not_dict": {"zh": "数据必须是 JSON 对象", "en": "Data must be a JSON object"},
    "add_model_validation_extra_keys": {"zh": "不允许的顶层字段：%s（仅允许 model_name、baseUrl、api、apiKey、models）", "en": "Disallowed top-level keys: %s (only model_name, baseUrl, api, apiKey, models)"},
    "add_model_validation_model_name_empty": {"zh": "model_name 不能为空", "en": "model_name is required"},
    "add_model_validation_model_name_format": {"zh": "model_name 须字母开头，仅允许字母、数字、下划线、连字符", "en": "model_name must start with a letter, only letters, digits, underscore, hyphen"},
    "add_model_validation_base_url_empty": {"zh": "baseUrl 不能为空", "en": "baseUrl is required"},
    "add_model_validation_base_url_format": {"zh": "baseUrl 须为有效网址（http:// 或 https:// 开头）", "en": "baseUrl must be a valid URL (http:// or https://)"},
    "add_model_validation_api_empty": {"zh": "api 不能为空", "en": "api is required"},
    "add_model_validation_models_empty": {"zh": "models 至少需要一项", "en": "models must have at least one item"},
    "add_model_validation_models_item_dict": {"zh": "models 第 %d 项须为对象", "en": "models[%d] must be an object"},
    "add_model_validation_models_id_required": {"zh": "models 第 %d 项的 id 必填", "en": "models[%d].id is required"},
    "add_model_validation_models_name_required": {"zh": "models 第 %d 项的 name 必填", "en": "models[%d].name is required"},
    "add_model_merged_console": {"zh": "已按规范合并配置，结果已打印到控制台（未发送到 Gateway）。请查看控制台输出是否合格。", "en": "Config merged successfully and printed to console (not sent to Gateway). Check console output."},
    "model_not_supported": {"zh": "暂不支持，请去配置文件修改。", "en": "Not supported. Edit config file."},
    "delete_model_title": {"zh": "删除模型", "en": "Delete model"},
    "delete_model_not_supported": {"zh": "暂时不支持，请去配置文件修改。\n\n请在「配置文件设置」中编辑 openclaw 配置，从 agents.defaults.models 中删除要移除的模型 key。", "en": "Not supported. Edit config in Config settings, remove model key from agents.defaults.models."},
    "skills_status_title": {"zh": "技能状态", "en": "Skills"},
    "cron_title": {"zh": "定时任务", "en": "Cron"},
    "please_connect_gateway": {"zh": "未连接 Gateway，请先连接。", "en": "Not connected to Gateway. Connect first."},
    "please_select_agent": {"zh": "请先选择 Agent（若列表为空，请确认已连接 Gateway 且 Gateway 已配置 agent）。", "en": "Select Agent first (if empty, connect Gateway and configure agent)."},
    "confirm_delete_title": {"zh": "确认删除", "en": "Confirm delete"},
    "confirm_delete_sessions": {"zh": "确定要删除选中的 %d 个会话吗？此操作不可恢复。", "en": "Delete %d selected session(s)? This cannot be undone."},
    "confirm_delete_sessions_server": {"zh": "确定要删除选中的 %d 个会话吗？将在服务器端删除，此操作不可恢复。", "en": "Delete %d selected session(s) on server? This cannot be undone."},
    "please_select_sessions_to_delete": {"zh": "请先勾选要删除的会话，或选中一行后点击删除", "en": "Select session(s) to delete, or select a row and click Delete"},
    "cannot_delete_server_sessions": {"zh": "未连接 Gateway，无法删除服务器会话", "en": "Not connected to Gateway, cannot delete server sessions"},
    "delete_done_title": {"zh": "删除完成", "en": "Delete done"},
    "delete_done_partial_fmt": {"zh": "已处理 %d 个会话，其中 %d 个删除失败：%s", "en": "Processed %d session(s), %d failed: %s"},
    "sessions_deleted_fmt": {"zh": "已删除 %d 个会话。", "en": "Deleted %d session(s)."},
    "sessions_delete_failed_fmt": {"zh": "有 %d 个会话删除失败", "en": "%d session(s) failed to delete"},
    "copy_session_key": {"zh": "复制 sessionKey", "en": "Copy sessionKey"},
    "open_chat_failed_fmt": {"zh": "打开聊天窗口失败：%s", "en": "Failed to open chat: %s"},
    "task_edit_title": {"zh": "修改任务", "en": "Edit task"},
    "task_add_title": {"zh": "增加任务", "en": "Add task"},
    "task_type_label": {"zh": "任务类型", "en": "Task type"},
    "task_type_timed": {"zh": "定时任务", "en": "Scheduled"},
    "task_type_recurring": {"zh": "循环任务", "en": "Recurring"},
    "task_type_cron": {"zh": "Cron 表达式", "en": "Cron expr"},
    "task_cron_expr_label": {"zh": "Cron 表达式", "en": "Cron expression"},
    "task_cron_expr_placeholder": {"zh": "如 0 20 * * *（每日 20:00）", "en": "e.g. 0 20 * * * (daily 20:00)"},
    "task_cron_tz_label": {"zh": "时区", "en": "Timezone"},
    "task_cron_tz_placeholder": {"zh": "如 Europe/Berlin、UTC", "en": "e.g. Europe/Berlin, UTC"},
    "task_desc_label": {"zh": "描述", "en": "Description"},
    "task_desc_placeholder": {"zh": "任务描述", "en": "Task description"},
    "task_target_time_label": {"zh": "目标时间", "en": "Target time"},
    "task_interval_label": {"zh": "间隔", "en": "Interval"},
    "task_priority_label": {"zh": "重要级别", "en": "Priority"},
    "task_priority_tooltip": {"zh": "重要级别，数字越小越重要", "en": "Lower number = higher priority"},
    "task_priority_1": {"zh": "1级（最高）", "en": "1 (highest)"},
    "task_priority_2": {"zh": "2级", "en": "2"},
    "task_priority_3": {"zh": "3级（最低）", "en": "3 (lowest)"},
    "task_default_desc": {"zh": "提醒", "en": "Reminder"},
    "task_banner_no_cron": {"zh": "当前 Gateway 未开放定时任务，或未连接。请先连接 Gateway 并确保服务端支持 cron.list。", "en": "Gateway cron not available or not connected. Connect and ensure cron.list is supported."},
    "task_search_label": {"zh": "搜索:", "en": "Search:"},
    "task_search_placeholder": {"zh": "按关键字搜索任务描述…", "en": "Search by description…"},
    "task_header_check": {"zh": "勾选", "en": "Check"},
    "task_header_level": {"zh": "级别/启用", "en": "Level/Enabled"},
    "task_header_type": {"zh": "任务类型", "en": "Type"},
    "task_header_desc": {"zh": "描述", "en": "Description"},
    "task_header_status": {"zh": "最后状态", "en": "Last status"},
    "task_btn_query": {"zh": "查询", "en": "Query"},
    "task_btn_add": {"zh": "增加", "en": "Add"},
    "task_btn_edit": {"zh": "修改", "en": "Edit"},
    "task_btn_del": {"zh": "删除", "en": "Delete"},
    "task_btn_run_once": {"zh": "运行一次", "en": "Run once"},
    "task_btn_run_tooltip": {"zh": "对选中任务执行 cron.run（仅 Gateway 模式）", "en": "Run cron.run for selected task (Gateway only)"},
    "task_btn_batch_del": {"zh": "批量删除", "en": "Batch delete"},
    "task_done_added": {"zh": "已添加任务", "en": "Task added"},
    "task_fail_add_fmt": {"zh": "添加任务失败", "en": "Add task failed"},
    "task_fail_add_id_conflict": {"zh": "添加任务失败（可能 ID 冲突）", "en": "Add task failed (ID conflict?)"},
    "task_no_manager": {"zh": "无任务管理器；请先连接 Gateway 并确保支持 cron.list。", "en": "No task manager. Connect Gateway and ensure cron.list."},
    "task_please_select_to_edit": {"zh": "请先选中一条待修改的任务", "en": "Select a task to edit"},
    "task_please_edit_pending_only": {"zh": "只能修改未完成任务，请选择上方的未完成任务", "en": "Only pending tasks can be edited"},
    "task_not_found": {"zh": "任务不存在", "en": "Task not found"},
    "task_done_updated": {"zh": "已更新任务", "en": "Task updated"},
    "task_fail_update": {"zh": "更新任务失败", "en": "Update task failed"},
    "task_please_select_to_del": {"zh": "请先选中要删除的任务", "en": "Select a task to delete"},
    "confirm_delete_task": {"zh": "确定要删除该任务吗？", "en": "Delete this task?"},
    "task_fail_del": {"zh": "删除任务失败", "en": "Delete task failed"},
    "task_please_select_to_run": {"zh": "请先选中要运行的任务", "en": "Select a task to run"},
    "task_done_run_once": {"zh": "已触发运行一次", "en": "Run once triggered"},
    "task_fail_run": {"zh": "运行失败", "en": "Run failed"},
    "task_please_select_to_batch_del": {"zh": "请先勾选要删除的任务", "en": "Select task(s) to delete"},
    "confirm_batch_delete_title": {"zh": "确认批量删除", "en": "Confirm batch delete"},
    "confirm_batch_delete_fmt": {"zh": "确定要删除选中的 %d 个任务吗？", "en": "Delete %d selected task(s)?"},
    "task_done_deleted_fmt": {"zh": "已删除 %d 个任务", "en": "Deleted %d task(s)"},
    "task_no_manager_short": {"zh": "无任务管理器", "en": "No task manager"},
    "task_enabled": {"zh": "启用", "en": "Enabled"},
    "task_disabled": {"zh": "禁用", "en": "Disabled"},
    "task_section_done": {"zh": "————— 已完成任务 —————", "en": "——— Done ———"},
    "task_unnamed": {"zh": "(无名称)", "en": "(unnamed)"},
    "log_remote_saved_fmt": {"zh": "远程 Gateway（已落盘: %s）", "en": "Remote Gateway (saved: %s)"},
    "skill_detail_title": {"zh": "技能详情", "en": "Skill detail"},
    "cron_detail_title": {"zh": "定时任务详情", "en": "Cron detail"},
    "session_source_label": {"zh": "会话来源：", "en": "Session source:"},
    "source_gateway": {"zh": "Gateway（服务器会话）", "en": "Gateway (server)"},
    "source_local": {"zh": "本地会话", "en": "Local"},
    "select_agent_label": {"zh": "选择 Agent：", "en": "Agent:"},
    "show_agent_to_agent": {"zh": "显示 Agent 对 Agent 会话", "en": "Show agent-to-agent sessions"},
    "show_agent_to_agent_tooltip": {"zh": "sessionKey 形如 agent:main:main 表示 Agent 对 Agent；默认不展示", "en": "e.g. agent:main:main; hidden by default"},
    "select_all": {"zh": "全选", "en": "Select all"},
    "new_session_btn": {"zh": "+ 新会话", "en": "+ New session"},
    "open_selected_btn": {"zh": "打开选中", "en": "Open selected"},
    "del_sessions_tooltip": {"zh": "删除勾选的会话；未勾选时删除当前选中行。Gateway 会话将在服务器端删除。", "en": "Delete selected or current row; server sessions deleted on server."},
    "tab_models": {"zh": "模型", "en": "Models"},
    "tab_skills": {"zh": "技能", "en": "Skills"},
    "tab_cron": {"zh": "定时任务", "en": "Cron"},
    "from_config_models": {"zh": "来自配置 agents.defaults.models", "en": "From agents.defaults.models"},
    "add_model_btn": {"zh": "增加模型", "en": "Add model"},
    "add_model_tooltip": {"zh": "在 Gateway 配置 agents.defaults.models 中增加模型，请通过「配置文件设置」编辑", "en": "Add model via Config settings."},
    "delete_model_btn": {"zh": "删除模型", "en": "Delete model"},
    "delete_model_tooltip": {"zh": "在 Gateway 配置 agents.defaults.models 中删除模型，请通过「配置文件设置」编辑", "en": "Remove model via Config settings."},
    "available_suffix": {"zh": " 可用", "en": " available"},
    "refresh_skills_btn": {"zh": "刷新技能状态", "en": "Refresh skills"},
    "refresh_cron_btn": {"zh": "刷新定时任务", "en": "Refresh cron"},
    "no_config_fetch": {"zh": "暂无配置（请打开配置或连接后拉取）", "en": "No config (fetch after connect)."},
    "no_config": {"zh": "暂无配置", "en": "No config"},
    "no_skills_data": {"zh": "无技能数据", "en": "No skills"},
    "unavailable_suffix": {"zh": " 不可用", "en": " unavailable"},
    "no_cron_tasks": {"zh": "无定时任务", "en": "No cron tasks"},
    "loading_dots": {"zh": "加载中…", "en": "Loading…"},
    "default_main": {"zh": "默认 (main)", "en": "Default (main)"},
    "new_session_default": {"zh": "新会话", "en": "New session"},
    "no_gateway_startup": {"zh": "（未连接 Gateway，请先启动页连接）", "en": "(Not connected. Connect on startup.)"},
    "request_failed": {"zh": "请求失败", "en": "Request failed"},
    "fail_item_fmt": {"zh": "[ 失败 ] %s", "en": "[ Failed ] %s"},
    "unnamed_short": {"zh": "(无名)", "en": "(unnamed)"},
    "msg_count_suffix": {"zh": " 条", "en": " msgs"},
    "agent_to_agent_suffix": {"zh": " (Agent 对 Agent)", "en": " (Agent to Agent)"},
    "etc_suffix": {"zh": " 等", "en": " etc."},
}


def get_locale() -> str:
    """当前界面语言：zh 或 en，从 Settings 读取，缺省 zh。带短时缓存，减少读盘。"""
    global _LOCALE_CACHE, _LOCALE_CACHE_TS
    now = time.time()
    if _LOCALE_CACHE is not None and (now - _LOCALE_CACHE_TS) < _LOCALE_CACHE_TTL_SEC:
        return _LOCALE_CACHE
    try:
        from config.settings import Settings
        s = Settings()
        s.load()
        loc = (s.get("locale") or "zh").strip().lower()
        _LOCALE_CACHE = loc if loc in ("zh", "en") else "zh"
        _LOCALE_CACHE_TS = now
        return _LOCALE_CACHE
    except Exception:
        _LOCALE_CACHE = "zh"
        _LOCALE_CACHE_TS = now
        return "zh"


def invalidate_locale_cache() -> None:
    """保存设置后调用，使下次 t() 时重新读取 locale。"""
    global _LOCALE_CACHE
    _LOCALE_CACHE = None


def t(key: str, fallback: Optional[str] = None) -> str:
    """按当前语言返回 key 对应文案；无 key 时返回 fallback 或 key。"""
    loc = get_locale()
    if key not in _STRINGS:
        return fallback if fallback is not None else key
    row = _STRINGS[key]
    return row.get(loc) or row.get("zh") or fallback or key
